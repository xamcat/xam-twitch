# REMEMBER TO SETUP FOLLOWING PIPELINE VARIABLES :
# BuildConfiguration

stages:
- stage: BuildXamarinAndroid
  jobs:
  - job: BuildXamarinAndroid
    displayName: Build Xamarin Android
    pool:
      name: Hosted macOS
      vmImage: 'macOS 10.14'
      demands:
      - MSBuild
      - Xamarin.Android
      
    steps:
    - script: echo Build Xamarin Android Stage!

    # - task: DownloadGitHubRelease@0
    #   inputs:
    #     connection: 'GitHub connection 6'
    #     userRepository: 'xamcat/mobcat-library'
    #     defaultVersionType: 'latest'
    #     downloadPath: '$(System.DefaultWorkingDirectory)/Packages'

    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    
    - script: nuget sources update -Name Local -Source "%BUILD_REPOSITORY_LOCALPATH%/LocalPackages"

    - task: NuGetCommand@2
      inputs:
        command: 'restore'
        restoreSolution: 'XamTwitch/XamTwitch.sln'
        feedsToUse: 'config'
        nugetConfigPath: 'build/Nuget.config'

    - task: XamarinAndroid@1
      displayName: 'Build Xamarin.Android App'
      inputs:
        projectFile: XamTwitch/XamTwitch.Android/XamTwitch.Android.csproj #yaml runs from root folder of repo
        configuration: '$(BuildConfiguration)'
        createAppPackage: false

  - job: BuildXamariniOS
    displayName: Build Xamarin iOS
    pool:
      name: Hosted macOS
      vmImage: 'macOS 10.14'
      demands:
      - xcode
      - Xamarin.iOS
      - msbuild

    steps:
    - script: echo Build Xamarin iOS Stage!

    # - task: DownloadGitHubRelease@0
    #   inputs:
    #     connection: 'GitHub connection 6'
    #     userRepository: 'xamcat/mobcat-library'
    #     defaultVersionType: 'latest'
    #     downloadPath: '$(System.DefaultWorkingDirectory)/Packages'

    - task: NuGetToolInstaller@1
      displayName: Use Nuget 5.0.2
      inputs:
        versionSpec: '5.0.2'

    - script: nuget sources update -Name Local -Source "%BUILD_REPOSITORY_LOCALPATH%/LocalPackages"

    - task: NuGetCommand@2
      inputs:
        command: 'restore'
        restoreSolution: 'XamTwitch/XamTwitch.sln'
        feedsToUse: 'config'
        nugetConfigPath: 'build/Nuget.config'
        
    - task: MSBuild@1
      displayName: 'Build  Xamarin.iOS App'
      inputs:
        solution: XamTwitch/XamTwitch.sln #yaml runs from root folder of repo
        platform: iPhoneSimulator
        configuration: '$(BuildConfiguration)'